<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FreshFlow - Demand Forecast Dashboard</title>
        <meta name="description" content="AI-powered demand forecasting dashboard for inventory management">

        <!-- Google Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet">

        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

        <style>
            :root {
                --primary: #6366f1;
                --primary-light: #818cf8;
                --primary-dark: #4f46e5;
                --secondary: #10b981;
                --accent: #f59e0b;
                --danger: #ef4444;
                --bg-dark: #0f172a;
                --bg-card: #1e293b;
                --bg-card-hover: #334155;
                --text-primary: #f8fafc;
                --text-secondary: #94a3b8;
                --text-muted: #64748b;
                --border: rgba(255, 255, 255, 0.1);
                --glass: rgba(30, 41, 59, 0.8);
                --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                background: var(--bg-dark);
                color: var(--text-primary);
                min-height: 100vh;
                line-height: 1.6;
            }

            /* Animated Background */
            .bg-gradient {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background:
                    radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                    radial-gradient(ellipse at 80% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                    radial-gradient(ellipse at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%);
                z-index: -1;
                animation: gradientShift 15s ease-in-out infinite;
            }

            @keyframes gradientShift {

                0%,
                100% {
                    transform: scale(1) rotate(0deg);
                }

                50% {
                    transform: scale(1.1) rotate(2deg);
                }
            }

            /* Layout */
            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem;
            }

            /* Header */
            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .logo {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .logo-icon {
                width: 48px;
                height: 48px;
                background: linear-gradient(135deg, var(--primary), var(--secondary));
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
            }

            .logo h1 {
                font-size: 1.75rem;
                font-weight: 700;
                background: linear-gradient(135deg, var(--text-primary), var(--primary-light));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .logo span {
                font-size: 0.875rem;
                color: var(--text-secondary);
            }

            /* Controls */
            .controls {
                display: flex;
                gap: 1rem;
                align-items: center;
                flex-wrap: wrap;
            }

            .select-wrapper {
                position: relative;
            }

            select {
                appearance: none;
                background: var(--bg-card);
                border: 1px solid var(--border);
                color: var(--text-primary);
                padding: 0.75rem 2.5rem 0.75rem 1rem;
                border-radius: 10px;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 200px;
            }

            select:hover,
            select:focus {
                border-color: var(--primary);
                outline: none;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            }

            .select-wrapper::after {
                content: 'â–¾';
                position: absolute;
                right: 1rem;
                top: 50%;
                transform: translateY(-50%);
                color: var(--text-secondary);
                pointer-events: none;
            }

            .btn {
                padding: 0.75rem 1.5rem;
                border-radius: 10px;
                font-size: 0.9rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                border: none;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .btn-primary {
                background: linear-gradient(135deg, var(--primary), var(--primary-dark));
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
            }

            .btn-secondary {
                background: var(--bg-card);
                color: var(--text-primary);
                border: 1px solid var(--border);
            }

            .btn-secondary:hover {
                background: var(--bg-card-hover);
            }

            /* Grid */
            .grid {
                display: grid;
                gap: 1.5rem;
            }

            .grid-3 {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }

            .grid-2 {
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            }

            /* Cards */
            .card {
                background: var(--glass);
                backdrop-filter: blur(20px);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 1.5rem;
                transition: all 0.3s ease;
            }

            .card:hover {
                transform: translateY(-4px);
                box-shadow: var(--shadow);
                border-color: rgba(99, 102, 241, 0.3);
            }

            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 1rem;
            }

            .card-title {
                font-size: 0.875rem;
                color: var(--text-secondary);
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .card-icon {
                width: 40px;
                height: 40px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
            }

            .card-icon.primary {
                background: rgba(99, 102, 241, 0.2);
            }

            .card-icon.success {
                background: rgba(16, 185, 129, 0.2);
            }

            .card-icon.warning {
                background: rgba(245, 158, 11, 0.2);
            }

            .card-icon.danger {
                background: rgba(239, 68, 68, 0.2);
            }

            .metric-value {
                font-size: 2.5rem;
                font-weight: 700;
                line-height: 1;
                margin-bottom: 0.25rem;
            }

            .metric-label {
                color: var(--text-secondary);
                font-size: 0.875rem;
            }

            .metric-change {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
                border-radius: 6px;
                margin-top: 0.5rem;
            }

            .metric-change.positive {
                background: rgba(16, 185, 129, 0.2);
                color: var(--secondary);
            }

            .metric-change.negative {
                background: rgba(239, 68, 68, 0.2);
                color: var(--danger);
            }

            /* Chart Container */
            .chart-container {
                background: var(--glass);
                backdrop-filter: blur(20px);
                border: 1px solid var(--border);
                border-radius: 16px;
                padding: 1.5rem;
                margin-top: 1.5rem;
            }

            .chart-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .chart-title {
                font-size: 1.25rem;
                font-weight: 600;
            }

            .chart-tabs {
                display: flex;
                gap: 0.5rem;
            }

            .chart-tab {
                padding: 0.5rem 1rem;
                border-radius: 8px;
                font-size: 0.85rem;
                cursor: pointer;
                background: transparent;
                color: var(--text-secondary);
                border: 1px solid transparent;
                transition: all 0.3s ease;
            }

            .chart-tab:hover {
                color: var(--text-primary);
            }

            .chart-tab.active {
                background: var(--primary);
                color: white;
                border-color: var(--primary);
            }

            .chart-wrapper {
                position: relative;
                height: 350px;
            }

            /* Table */
            .table-container {
                overflow-x: auto;
                margin-top: 1.5rem;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th,
            td {
                padding: 1rem;
                text-align: left;
                border-bottom: 1px solid var(--border);
            }

            th {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-secondary);
                font-weight: 600;
            }

            tr:hover td {
                background: rgba(99, 102, 241, 0.05);
            }

            .confidence-bar {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .confidence-bar-track {
                flex: 1;
                height: 6px;
                background: var(--bg-card);
                border-radius: 3px;
                overflow: hidden;
            }

            .confidence-bar-fill {
                height: 100%;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                border-radius: 3px;
                transition: width 0.5s ease;
            }

            /* Loading State */
            .loading {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 4rem;
                color: var(--text-secondary);
            }

            .spinner {
                width: 48px;
                height: 48px;
                border: 3px solid var(--border);
                border-top-color: var(--primary);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 1rem;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* Empty State */
            .empty-state {
                text-align: center;
                padding: 4rem 2rem;
                color: var(--text-secondary);
            }

            .empty-state-icon {
                font-size: 4rem;
                margin-bottom: 1rem;
                opacity: 0.5;
            }

            /* Responsive */
            @media (max-width: 768px) {
                .container {
                    padding: 1rem;
                }

                header {
                    flex-direction: column;
                    align-items: stretch;
                }

                .controls {
                    flex-direction: column;
                }

                select,
                .btn {
                    width: 100%;
                }
            }
        </style>
    </head>

    <body>
        <div class="bg-gradient"></div>

        <div class="container">
            <header>
                <div class="logo">
                    <div class="logo-icon">ðŸ“Š</div>
                    <div>
                        <h1>FreshFlow</h1>
                        <span>Demand Forecast Dashboard</span>
                    </div>
                </div>

                <div class="controls">
                    <div class="select-wrapper">
                        <select id="placeSelect">
                            <option value="">Select a Location</option>
                            {% for place in places %}
                            <option value="{{ place.id }}">{{ place.title }} ({{ place.order_count }} orders)</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="select-wrapper">
                        <select id="itemSelect" disabled>
                            <option value="">All Items (Place-level)</option>
                        </select>
                    </div>

                    <div class="select-wrapper">
                        <select id="horizonSelect">
                            <option value="7">Next 7 Days</option>
                            <option value="14">Next 14 Days</option>
                            <option value="30">Next 30 Days</option>
                        </select>
                    </div>

                    <button id="generateBtn" class="btn btn-primary">
                        <span>âš¡</span> Generate Forecast
                    </button>

                    <button id="refreshBtn" class="btn btn-secondary">
                        <span>ðŸ”„</span> Refresh
                    </button>
                </div>
            </header>

            <!-- Metrics Cards -->
            <div class="grid grid-3" id="metricsGrid">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Model Accuracy (MAPE)</span>
                        <div class="card-icon primary">ðŸ“ˆ</div>
                    </div>
                    <div class="metric-value" id="mapeValue">--%</div>
                    <div class="metric-label">Mean Absolute Percentage Error</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Total Predicted Demand</span>
                        <div class="card-icon success">ðŸ“¦</div>
                    </div>
                    <div class="metric-value" id="totalDemand">--</div>
                    <div class="metric-label">Units for selected period</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Forecast Range</span>
                        <div class="card-icon warning">ðŸ“…</div>
                    </div>
                    <div class="metric-value" id="forecastRange">--</div>
                    <div class="metric-label">Days forecasted</div>
                </div>
            </div>

            <!-- Main Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Demand Forecast</h2>
                    <div class="chart-tabs">
                        <button class="chart-tab active" data-view="forecast">Forecast</button>
                        <button class="chart-tab" data-view="trend">Trend</button>
                        <button class="chart-tab" data-view="seasonality">Weekly Pattern</button>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <canvas id="forecastChart"></canvas>
                </div>
            </div>

            <!-- Forecast Table -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Detailed Predictions</h2>
                </div>

                <div class="table-container" id="forecastTableContainer">
                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-icon">ðŸ“Š</div>
                        <h3>No Forecasts Available</h3>
                        <p>Select a location and click "Generate Forecast" to start</p>
                    </div>

                    <table id="forecastTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Predicted Quantity</th>
                                <th>Confidence (80%)</th>
                                <th>Confidence (95%)</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody id="forecastTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // State
            let currentData = null;
            let forecastChart = null;

            // DOM Elements
            const placeSelect = document.getElementById('placeSelect');
            const itemSelect = document.getElementById('itemSelect');
            const horizonSelect = document.getElementById('horizonSelect');
            const generateBtn = document.getElementById('generateBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const emptyState = document.getElementById('emptyState');
            const forecastTable = document.getElementById('forecastTable');
            const forecastTableBody = document.getElementById('forecastTableBody');

            // Initialize Chart
            function initChart() {
                const ctx = document.getElementById('forecastChart').getContext('2d');

                forecastChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Predicted Demand',
                                data: [],
                                borderColor: '#6366f1',
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Upper Bound (80%)',
                                data: [],
                                borderColor: 'rgba(16, 185, 129, 0.5)',
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.4,
                                borderWidth: 1,
                                pointRadius: 0
                            },
                            {
                                label: 'Lower Bound (80%)',
                                data: [],
                                borderColor: 'rgba(239, 68, 68, 0.5)',
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.4,
                                borderWidth: 1,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#94a3b8',
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#f8fafc',
                                bodyColor: '#94a3b8',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1,
                                padding: 12,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: '#64748b'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: '#64748b'
                                }
                            }
                        }
                    }
                });
            }

            // Fetch Forecasts
            async function fetchForecasts(placeId, days = 7, itemId = null) {
                try {
                    let url = `/forecast/api/forecast/${placeId}/?days=${days}`;
                    if (itemId) {
                        url = `/forecast/api/forecast/${placeId}/item/${itemId}/?days=${days}`;
                    }
                    const response = await fetch(url);

                    if (response.status === 404) {
                        return null;
                    }

                    if (!response.ok) {
                        throw new Error('Failed to fetch forecasts');
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error fetching forecasts:', error);
                    return null;
                }
            }

            // Generate Forecasts
            async function generateForecasts(placeId, days = 7, itemId = null) {
                try {
                    generateBtn.disabled = true;
                    generateBtn.innerHTML = '<span class="spinner" style="width:16px;height:16px;border-width:2px;"></span> Generating...';

                    const requestBody = {
                        place_id: parseInt(placeId),
                        days_ahead: parseInt(days)
                    };

                    // Add item_id if specified
                    if (itemId) {
                        requestBody.item_ids = [parseInt(itemId)];
                    }

                    const response = await fetch('/forecast/api/forecast/generate/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Generation failed');
                    }

                    const result = await response.json();

                    // Refresh data after generation
                    await loadData(placeId, days, itemId);

                    return result;
                } catch (error) {
                    console.error('Error generating forecasts:', error);
                    alert('Failed to generate forecasts: ' + error.message);
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<span>âš¡</span> Generate Forecast';
                }
            }

            // Update UI with data
            function updateUI(data) {
                if (!data || !data.forecasts || data.forecasts.length === 0) {
                    emptyState.style.display = 'block';
                    forecastTable.style.display = 'none';
                    document.getElementById('mapeValue').textContent = '--%';
                    document.getElementById('totalDemand').textContent = '--';
                    document.getElementById('forecastRange').textContent = '--';
                    return;
                }

                currentData = data;

                // Update metrics
                document.getElementById('mapeValue').textContent =
                    data.metrics.mape ? `${data.metrics.mape}%` : 'N/A';

                const totalDemand = data.forecasts.reduce((sum, f) => sum + f.predicted_quantity, 0);
                document.getElementById('totalDemand').textContent = Math.round(totalDemand).toLocaleString();
                document.getElementById('forecastRange').textContent = `${data.forecasts.length} days`;

                // Update chart
                const labels = data.forecasts.map(f => {
                    const date = new Date(f.forecast_date);
                    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                });

                forecastChart.data.labels = labels;
                forecastChart.data.datasets[0].data = data.forecasts.map(f => f.predicted_quantity);
                forecastChart.data.datasets[1].data = data.forecasts.map(f => f.upper_bound_80);
                forecastChart.data.datasets[2].data = data.forecasts.map(f => f.lower_bound_80);
                forecastChart.update();

                // Update table
                emptyState.style.display = 'none';
                forecastTable.style.display = 'table';

                forecastTableBody.innerHTML = data.forecasts.map(f => {
                    const date = new Date(f.forecast_date);
                    const formattedDate = date.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    const confidence80 = f.upper_bound_80 - f.lower_bound_80;
                    const confidence95 = f.upper_bound_95 - f.lower_bound_95;

                    return `
                    <tr>
                        <td>${formattedDate}</td>
                        <td><strong>${f.predicted_quantity.toFixed(1)}</strong></td>
                        <td>${f.lower_bound_80?.toFixed(1) || 'N/A'} - ${f.upper_bound_80?.toFixed(1) || 'N/A'}</td>
                        <td>${f.lower_bound_95?.toFixed(1) || 'N/A'} - ${f.upper_bound_95?.toFixed(1) || 'N/A'}</td>
                        <td>${f.trend?.toFixed(1) || 'N/A'}</td>
                    </tr>
                `;
                }).join('');
            }

            // Load data
            async function loadData(placeId, days, itemId = null) {
                if (!placeId) {
                    updateUI(null);
                    return;
                }

                const data = await fetchForecasts(placeId, days, itemId);
                updateUI(data);
            }

            // Load items for a place
            async function loadItems(placeId) {
                if (!placeId) {
                    itemSelect.innerHTML = '<option value="">All Items (Place-level)</option>';
                    itemSelect.disabled = true;
                    return;
                }

                try {
                    itemSelect.innerHTML = '<option value="">Loading items...</option>';
                    const response = await fetch(`/forecast/api/forecast/places/${placeId}/items/`);

                    if (!response.ok) {
                        throw new Error('Failed to load items');
                    }

                    const data = await response.json();

                    itemSelect.innerHTML = '<option value="">All Items (Place-level)</option>';
                    data.items.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.item_id;
                        option.textContent = `${item.item_name} (${item.order_count} orders)`;
                        itemSelect.appendChild(option);
                    });
                    itemSelect.disabled = false;
                } catch (error) {
                    console.error('Error loading items:', error);
                    itemSelect.innerHTML = '<option value="">All Items (Place-level)</option>';
                    itemSelect.disabled = true;
                }
            }

            // Event Listeners
            placeSelect.addEventListener('change', () => {
                const placeId = placeSelect.value;
                const days = horizonSelect.value;
                loadItems(placeId);
                loadData(placeId, days);
            });

            horizonSelect.addEventListener('change', () => {
                const placeId = placeSelect.value;
                const days = horizonSelect.value;
                if (placeId) {
                    loadData(placeId, days);
                }
            });

            generateBtn.addEventListener('click', () => {
                const placeId = placeSelect.value;
                const itemId = itemSelect.value;
                const days = horizonSelect.value;

                if (!placeId) {
                    alert('Please select a location first');
                    return;
                }

                generateForecasts(placeId, days, itemId || null);
            });

            refreshBtn.addEventListener('click', () => {
                const placeId = placeSelect.value;
                const itemId = itemSelect.value;
                const days = horizonSelect.value;
                if (placeId) {
                    loadData(placeId, days, itemId || null);
                }
            });

            // Chart tabs
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');

                    const view = e.target.dataset.view;
                    updateChartView(view);
                });
            });

            function updateChartView(view) {
                if (!currentData || !currentData.forecasts) return;

                const forecasts = currentData.forecasts;

                switch (view) {
                    case 'trend':
                        forecastChart.data.datasets[0].data = forecasts.map(f => f.trend || 0);
                        forecastChart.data.datasets[0].label = 'Trend Component';
                        forecastChart.data.datasets[1].data = [];
                        forecastChart.data.datasets[2].data = [];
                        break;

                    case 'seasonality':
                        forecastChart.data.datasets[0].data = forecasts.map(f => f.weekly_seasonality || 0);
                        forecastChart.data.datasets[0].label = 'Weekly Seasonality';
                        forecastChart.data.datasets[1].data = [];
                        forecastChart.data.datasets[2].data = [];
                        break;

                    default:
                        forecastChart.data.datasets[0].data = forecasts.map(f => f.predicted_quantity);
                        forecastChart.data.datasets[0].label = 'Predicted Demand';
                        forecastChart.data.datasets[1].data = forecasts.map(f => f.upper_bound_80);
                        forecastChart.data.datasets[2].data = forecasts.map(f => f.lower_bound_80);
                }

                forecastChart.update();
            }

            // Initialize
            initChart();
        </script>
    </body>

</html>